<!doctype html>
<html lang="pl" data-theme="light">
<head>
<meta charset="utf-8"/>
<title>Daily Drop</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>

<style>
:root{
  --bg:#f3f4f6;--card:#ffffff;--text:#0f172a;--muted:#64748b;
  --border:#e5e7eb;--accent:#2563eb;--danger:#ef4444;
}
body{margin:0;font-family:system-ui;background:var(--bg);color:var(--text)}
.wrap{max-width:980px;margin:0 auto;padding:16px}
.topbar{display:flex;justify-content:space-between;align-items:center;
  background:var(--card);padding:12px;border-radius:16px;border:1px solid var(--border)}
.actions{display:flex;gap:8px;flex-wrap:wrap}
.btn{padding:8px 12px;border-radius:999px;border:1px solid var(--border);
  background:#fff;font-weight:700;cursor:pointer}
.btn.primary{background:var(--accent);color:#fff;border:none}
.btn.danger{background:#fee2e2;color:#b91c1c;border:none}
.card{margin-top:12px;background:#fff;padding:14px;border-radius:16px;border:1px solid var(--border)}
.board{display:grid;gap:2px;margin-top:12px}
.cell{aspect-ratio:1;border:1px solid #cbd5e1;display:flex;align-items:center;justify-content:center}
.cell.block{background:#0f172a}
.cell input{width:100%;height:100%;border:none;text-align:center;font-weight:800;font-size:18px}
.modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.6)}
.modal.active{display:flex}
.modal-card{background:#fff;padding:16px;border-radius:16px;width:90%;max-width:420px}
.archive-item{display:flex;justify-content:space-between;padding:8px;border:1px solid #e5e7eb;
  border-radius:12px;margin-bottom:6px;cursor:pointer}
.badge.ok{color:#16a34a;font-weight:700}
.badge.no{color:#dc2626;font-weight:700}

/* CLUES */
.grid2{display:grid;grid-template-columns:1fr 1fr;gap:12px;align-items:start}
@media (max-width: 900px){
  .grid2{grid-template-columns:1fr}
}
.clue{
  padding:10px;
  border:1px solid #e5e7eb;
  border-radius:12px;
  margin-bottom:8px;
  background:#fff;
}
.clue .top{
  display:flex;justify-content:space-between;gap:10px;
  font-weight:800;
}
.clue .meta{
  color:#64748b;font-size:12px;font-weight:700;
}
</style>
</head>

<body>
<div class="wrap">

<header class="topbar">
  <div>
    <strong>DAILY DROP</strong><br>
    <small id="subtitle">Daily</small>
  </div>
  <div class="actions">
    <button class="btn primary" id="reloadBtn">Odśwież dziś</button>
    <button class="btn" id="archiveBtn">Archiwum</button>
    <button class="btn danger" id="resetBtn" disabled>Reset</button>
    <button class="btn" id="devImportBtn" style="display:none">Import (dev)</button>
  </div>
</header>

<section class="card grid2">
  <div>
    <div id="status">Status: —</div>
    <div id="board" class="board"></div>
  </div>

  <div>
    <h3 style="margin:0 0 8px">Definicje</h3>
    <div id="cluesBox" style="color:var(--muted)">—</div>
  </div>
</section>

</div>

<!-- ARCHIWUM -->
<div class="modal" id="archiveModal">
  <div class="modal-card">
    <h3>Archiwum (14 dni)</h3>
    <div id="archiveList"></div>
    <button class="btn" id="archiveCloseBtn">Zamknij</button>
  </div>
</div>

<script>
(() => {
  const board = document.getElementById("board");
  const statusEl = document.getElementById("status");
  const subtitleEl = document.getElementById("subtitle");
  const cluesBox = document.getElementById("cluesBox");
  const archiveModal = document.getElementById("archiveModal");
  const archiveList = document.getElementById("archiveList");

  const params = new URLSearchParams(location.search);
  const isDev = params.get("dev") === "1";
  if (isDev) document.getElementById("devImportBtn").style.display = "inline-block";

  // auto source on GH Pages
  const baseUrl = location.origin + "/daily-drop/crosswords";

  function today() {
    const d = new Date();
    return d.toISOString().slice(0, 10);
  }

  function setStatus(t) { statusEl.textContent = "Status: " + t; }

  async function loadDay(date) {
    setStatus("ładowanie…");
    subtitleEl.textContent = "Daily • " + date;

    try {
      const res = await fetch(`${baseUrl}/${date}.json`, { cache: "no-store" });
      if (!res.ok) throw new Error("HTTP " + res.status);
      const json = await res.json();

      renderBoard(json.grid);
      renderClues(json);

      setStatus("OK");
      document.getElementById("resetBtn").disabled = false;
    } catch (e) {
      console.warn(e);
      board.innerHTML = "";
      cluesBox.innerHTML = "";
      setStatus("brak krzyżówki");
      document.getElementById("resetBtn").disabled = true;
    }
  }

  function renderBoard(grid) {
    if (!Array.isArray(grid) || !Array.isArray(grid[0])) {
      board.innerHTML = "";
      return;
    }

    const n = grid.length;
    board.style.gridTemplateColumns = `repeat(${n}, 1fr)`;
    board.innerHTML = "";

    grid.forEach(row => {
      row.forEach(cell => {
        const d = document.createElement("div");
        d.className = "cell" + (cell === "" ? " block" : "");
        if (cell !== "") {
          const i = document.createElement("input");
          i.maxLength = 1;
          d.appendChild(i);
        }
        board.appendChild(d);
      });
    });
  }

  function renderClues(json) {
    const runs = Array.isArray(json?.runs) ? json.runs : [];
    const clues = (json?.clues && typeof json.clues === "object") ? json.clues : {};

    if (!runs.length) {
      cluesBox.innerHTML = `<div style="color:var(--muted)">Brak definicji w JSON (brak pola <b>runs</b>).</div>`;
      return;
    }

    let html = "";
    runs.forEach((r, idx) => {
      const rawWord = (r.word || "").toString();
      const wordKey = rawWord.toUpperCase();
      const clueText = clues[wordKey] || clues[rawWord] || "—";
      const dir = (r.direction === "down") ? "pionowo" : "poziomo";
      const len = (r.length || rawWord.length || "—");

      html += `
        <div class="clue">
          <div class="top">
            <span>${idx + 1}.</span>
            <span class="meta">${dir} • ${len}</span>
          </div>
          <div>${escapeHtml(clueText)}</div>
        </div>
      `;
    });

    cluesBox.innerHTML = html;
  }

  function escapeHtml(s){
    return String(s)
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }

  // ARCHIVE
  function openArchive() {
    archiveModal.classList.add("active");
    buildArchive();
  }
  function closeArchive() {
    archiveModal.classList.remove("active");
  }

  async function buildArchive() {
    archiveList.innerHTML = "";
    for (let i = 0; i < 14; i++) {
      const d = new Date();
      d.setDate(d.getDate() - i);
      const date = d.toISOString().slice(0, 10);

      const row = document.createElement("div");
      row.className = "archive-item";
      row.innerHTML = `<span>${date}</span><span class="badge">…</span>`;
      archiveList.appendChild(row);

      try {
        const r = await fetch(`${baseUrl}/${date}.json`, { cache: "no-store" });
        if (r.ok) {
          row.querySelector(".badge").textContent = "OK";
          row.querySelector(".badge").className = "badge ok";
          row.onclick = () => { closeArchive(); loadDay(date); };
        } else {
          throw new Error("HTTP " + r.status);
        }
      } catch {
        row.querySelector(".badge").textContent = "brak";
        row.querySelector(".badge").className = "badge no";
      }
    }
  }

  // BUTTONS
  document.getElementById("archiveBtn").onclick = openArchive;
  document.getElementById("archiveCloseBtn").onclick = closeArchive;
  archiveModal.addEventListener("click", (e) => {
    if (e.target === archiveModal) closeArchive();
  });

  document.getElementById("reloadBtn").onclick = () => loadDay(today());

  // Reset (na razie: czyści wpisane litery w UI)
  document.getElementById("resetBtn").onclick = () => {
    if (!confirm("Zresetować wpisane litery?")) return;
    board.querySelectorAll("input").forEach(i => i.value = "");
  };

  // init
  loadDay(today());
})();
</script>

</body>
</html>
